---
title: "Greenhouse Gas Emissions 2018"
author: "Gabriel Berlin"
date: "11/29/2019"
output: html_notebook
---

# The Greenhouse gas reporting program is a program run by the Environmental Protection Agency that requires all U.S. facilities emitting over 25,000 metric tons of CO2 per year to record and report their emissions. The EPA makes these data publicly available. 
# In this project I will look at greenhouse gas emissions across industries and states. Knowing the source of emissions will help more effectively reduce those emissions. 

## load packages and data
### packages
```{r}
# clear environment
rm(list = ls()) 

# load pakcages
library(DataComputing)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(mosaic)
library(mosaicData)
library(readr)
library(maps)
library(rvest)
```

### data
```{r}
fullEmissionsTable <- read_csv("direct_emitters.csv", skip = 3)
data("ZipGeography")
```

## view data
### view emissions table data
```{r}
names(fullEmissionsTable)
head(fullEmissionsTable, 10)
```
### view population data
```{r}
names(ZipGeography)
head(ZipGeography, 10)
```

The table's columns contain information about three different things: information about the facility, actual emissions data, and how gasses were emitted. How gasses were emitted is beyond the scopeof  the research question, so I will focus on only the first two categories and I will get rid of the variables I do not need. 

## data wrangling
### data wrangling of emissions table
```{r}
emissionsTable <- 
  fullEmissionsTable %>%
  rename(sector = `Industry Type (sectors)`) %>%
  select(`Facility Id`, `FRS Id`, `Facility Name`, `State`, Latitude, Longitude, 
         `sector`, `Total reported direct emissions`, 
         `CO2 emissions (non-biogenic)`, `Methane (CH4) emissions`, 
         `Nitrous Oxide (N2O) emissions`, `HFC emissions`, `PFC emissions`, `SF6 emissions`,
         `NF3 emissions`, `Other Fully Fluorinated GHG emissions`, `HFE emissions`,
         `Other GHGs (metric tons CO2e)`, `Biogenic CO2 emissions (metric tons)`)
```

#### list of sectors/industries
```{r}
emissionsTable %>%
  group_by(sector) %>%
  summarise(total = n()) %>%
  arrange(desc(total))
```

There are multiple sectors in some of the values. For example, "Chemicals,Coal-based Liquid Fuel Supply,Suppliers of CO2". Because there are multiple values in a single cell, this data is not in tidy form. To make it in tidy form I will make sure there is only one value in a cell. Additionally, these details are not relevant. I will need to use regular expressions and a loop to replace the values.

#### set the sectors equal to simplified version
```{r}
chem <- "Chemicals"
metals <- "Metals"
minerals <- "Minerals"
natural <- "Natural Gas"
other <- "Other"
petro <- "Petroleum"
paper <- "Pulp"
power <- "Power Plants"
injection <- "Injection"

s <- "" # variable needed to loop through table
i <- 0 # for loop counter variable

for (i in 1:nrow(emissionsTable)) {
  s <- emissionsTable[i, "sector"]  # access sector value in each row
  if (grepl(pattern = "^Chemical", s)) {
    emissionsTable[i, "sector"] = chem
  }  else if (grepl(pattern = "^Metals", s)) {
    emissionsTable[i, "sector"] = metals
  } else if (grepl(pattern = "^Minerals", s)) {
    emissionsTable[i, "sector"] = minerals
  } else if (grepl(pattern = "^Natural", s)) {
    emissionsTable[i, "sector"] = natural
  } else if (grepl(pattern = "^Petroleum", s)) {
    emissionsTable[i, "sector"] = petro
  } else if (grepl(pattern = "^Pulp", s)) {
    emissionsTable[i, "sector"] = paper
  } else if (grepl(pattern = "^Injection", s)) {
   emissionsTable[i, "sector"] = injection
  } else if (grepl(pattern = "^Power Plant", s)) {
    emissionsTable[i, "sector"] = power
  } else {
    emissionsTable[i, "sector"] = other
  }
}
```

### data wrangling of zip geography table: need population and state
#### population by state
```{r}
PopulationByState <- ZipGeography %>%
  select(State, Population) %>%
  group_by(State) %>% 
  summarise(POPSUM = sum(Population, na.rm=TRUE))
PopulationByState
```


# now that the data is in glyph ready form, I will display tables and graphs of the data
## View all emissions by sector
```{r}
sectorEmissions <-
  emissionsTable %>%
  group_by(sector) %>%
  summarise(emissions = sum(`Total reported direct emissions`), carbon = sum(`CO2 emissions (non-biogenic)`, na.rm = TRUE), methane = sum(`Methane (CH4) emissions`, na.rm = TRUE)) %>% 
  arrange(desc(emissions))
sectorEmissions
```

This table shows that power plants are, by far, the biggest polluter out of all industries in the economy.

# Data Visualizaitons
## emissions for all facilities
```{r}
emissionsTable %>%
  ggplot(aes(x = `Total reported direct emissions`)) + geom_density() + xlim(0, 500000)
emissionsTable %>%
  ggplot(aes(x = `Total reported direct emissions`, y = 1)) + geom_point(alpha = .2, position = "jitter") + xlab("emissions") + xlim(0, 500000)
```

This shows that the vast majority of facilities emit between 0 and 100,000 metric tons of greenhouse gasses.

## Barchart of emissions by sector
```{r}
sectorEmissions %>%
  ggplot(aes(x = sector, y = emissions, reorder(emissions))) + geom_bar(stat = "identity")
```

## View CO2 and methane emissions 
```{r}
sectorEmissions %>% 
  ggplot() + xlab() + geom_bar(stat = "identity") + facet_wrap(sector)
```

# Total emissions by state
```{r}
emissionsTable %>%
  group_by(State) %>%
  summarise(emissions = sum(`Total reported direct emissions`))
```

## Emissions by state per capita
### join on population and emissions table
The emissions table has state abbreviations, the population table has the full name of the state. It would be tedious to write 50 if else statements and a for loop, so instead I will join the population table with a table of state abbrevations


populationByState <-
  populationByState %>%
  left_join(abbreviationTable, Name) %>%
  select(Name, `2018 Population`, )


