---
title: "Greenhouse Gas Emissions 2018"
author: "Gabriel Berlin"
date: "11/29/2019"
output: html_notebook
---

# The Greenhouse gas reporting program is a program run by the Environmental Protection Agency that requires all U.S. facilities emitting over 25,000 metric tons of CO2 per year to record and report their emissions. The EPA makes these data publicly available. 
# In this project I will look at greenhouse gas emissions across industries and states. Knowing the source of emissions will help more effectively reduce those emissions. 

## load packages
```{r}
# clear environment
rm(list = ls()) 

# load pakcages
library(DataComputing)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(mosaic)
library(mosaicData)
library(readr)
library(maps)
library(rvest)
```

## load data
```{r}
fullEmissionsTable <- read_csv("/home/gabriel/college/Greenhouse Gas Emissions 2018/direct_emitters.csv", skip = 3)z
populationWebPage <- "https://en.m.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States_by_population"
popByStateTables <-
  populationWebPage %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)

populationByState <- popByStateTables[[1]]
```

## view emissions table data
```{r}
names(fullEmissionsTable)
head(fullEmissionsTable, 10)
```

## view population data
```{r}
names(populationByState)
head(populationByState, 10)
```



The table's columns contain information about three different things: information about the facility, actual emissions data, and how gasses were emitted. How gasses were emitted is beyond the scopeof  the research question, so I will focus on only the first two categories and I will get rid of the variables I do not need. 

## data wrangling of emissions table
```{r}
emissionsTable <- 
  fullEmissionsTable %>%
  rename(sector = `Industry Type (sectors)`) %>%
  select(`Facility Id`, `FRS Id`, `Facility Name`, `State`, Latitude, Longitude, 
         `sector`, `Total reported direct emissions`, 
         `CO2 emissions (non-biogenic)`, `Methane (CH4) emissions`, 
         `Nitrous Oxide (N2O) emissions`, `HFC emissions`, `PFC emissions`, `SF6 emissions`,
         `NF3 emissions`, `Other Fully Fluorinated GHG emissions`, `HFE emissions`,
         `Other GHGs (metric tons CO2e)`, `Biogenic CO2 emissions (metric tons)`)
```

## View list of sectors/industries
```{r}
emissionsTable %>%
  group_by(sector) %>%
  summarise(total = n()) %>%
  arrange(desc(total))
```

### There are multiple sectors in some of the values. For example, "Chemicals,Coal-based Liquid Fuel Supply,Suppliers of CO2". Because there are multiple values in a single cell, this data is not in tidy form. To make it in tidy form I will make sure there is only one value in a cell. Additionally, these details are not relevant. I will need to use regular expressions and a loop to replace the values.

## set the sectors equal to simplified version
```{r}
chem <- "Chemicals"
metals <- "Metals"
minerals <- "Minerals"
natural <- "Natural Gas"
other <- "Other"
petro <- "Petroleum"
paper <- "Pulp"
power <- "Power Plants"
injection <- "Injection"

s <- "" # variable needed to loop through table
i <- 0 # for loop counter variable

for (i in 1:nrow(emissionsTable)) {
  s <- emissionsTable[i, "sector"]  # access sector value in each row
  if (grepl(pattern = "^Chemical", s)) {
    emissionsTable[i, "sector"] = chem
  }  else if (grepl(pattern = "^Metals", s)) {
    emissionsTable[i, "sector"] = metals
  } else if (grepl(pattern = "^Minerals", s)) {
    emissionsTable[i, "sector"] = minerals
  } else if (grepl(pattern = "^Natural", s)) {
    emissionsTable[i, "sector"] = natural
  } else if (grepl(pattern = "^Petroleum", s)) {
    emissionsTable[i, "sector"] = petro
  } else if (grepl(pattern = "^Pulp", s)) {
    emissionsTable[i, "sector"] = paper
  } else if (grepl(pattern = "^Injection", s)) {
   emissionsTable[i, "sector"] = injection
  } else if (grepl(pattern = "^Power Plant", s)) {
    emissionsTable[i, "sector"] = power
  } else {
    emissionsTable[i, "sector"] = other
  }
}
```

## data wrangling of population table
```{r}
populationByState <-
  populationByState %>%
  select(Name, `Population estimate, July 1, 2018[5]`) %>%
  rename("2018 Population" = `Population estimate, July 1, 2018[5]`)
```

## View all emissions by sector
```{r}
sectorEmissions <-
  emissionsTable %>%
  group_by(sector) %>%
  summarise(emissions = sum(`Total reported direct emissions`)) %>%
  arrange(desc(emissions))
sectorEmissions
```

## Barchart of emissions by sector
```{r}
barGraphHelper(data = sectorEmissions)
```

## View CO2 and methane emissions 
```{r}
emissionsTable %>%
  group_by(sector) %>%
  summarise("CO2 Emissions" = sum(`CO2 emissions (non-biogenic)`, na.rm = TRUE),
            "Methand Emissions" = sum(`Methane (CH4) emissions`, na.rm = TRUE))
```

# Total emissions by state
```{r}
emissionsTable %>%
  group_by(State) %>%
  summarise(emissions = sum(`Total reported direct emissions`))
```

## Emissions by state per capita
### join on population and emissions table
The emissions table has state abbreviations, the population table has the full name of the state. It would be tedious to write 50 if else statements and a for loop, so instead I will join the population table with a table of state abbrevations

```{r}
populationByState <-
  populationByState %>%
  left_join(abbreviationTable, Name) %>%
  select(Name, `2018 Population`, )
```


Would be better to get emissions on a per capita basis by state. Each of these states have huge differences in population size
# get table with states and population
# add total emissions to that table
# divide emissions per state by populaiton of that state

Will be interesting to see a map with emissions superimposed
```{r}
data("usaMapEnv")
```

